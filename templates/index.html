<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generate Google Forms</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body { padding: 20px; }
    textarea { resize: vertical; }
    .prompt-container {
      margin-bottom: 3rem;
    }
    .prompt-history {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 5px;
    }
    .prompt-history a {
      display: block;
      padding: 5px 10px;
      cursor: pointer;
      text-decoration: none;
      color: #333;
    }
    .prompt-history a:hover {
      background-color: #f5f5f5;
    }
    .correct-answer {
      font-weight: bold;
      color: green;
    }
    .form-preview {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 1.5rem;
    }
    .form-preview h5 {
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="display-4 text-center mb-4">Generate Google Forms</h1>

    <div class="prompt-container">
      {% if "credentials" not in session %}
        <p class="text-center">Please log in with your Google account to use this application.</p>
        <div class="text-center">
          <a href="{{ url_for('login') }}" class="btn btn-primary btn-lg">Login with Google</a>
        </div>
      {% else %}
        <form method="POST">
          <div class="form-group">
            <label for="prompt">Prompt:</label>
            <textarea class="form-control" id="prompt" name="prompt" rows="5" placeholder="Enter your prompt here..." required></textarea>
          </div>
          <button type="submit" class="btn btn-primary btn-block">Generate Form</button>
        </form>

        <div class="mt-3">
          <strong>Prompt History:</strong>
          <div class="prompt-history">
            {% for p in prompt_history %}
              <a href="#" class="list-group-item">{{ p[:100] }}{% if p|length > 100 %}...{% endif %}</a>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>

    {% if form_preview_data %}
      <div class="form-preview">
        <h5>Form Preview:</h5>
        {% for request in form_preview_data.requests %}
          {% if request.createItem %}
            <div class="card mb-3">
              <div class="card-body">
                <h5 class="card-title">{{ request.createItem.item.title }}</h5>
                {% if request.createItem.item.questionItem.question.choiceQuestion %}
                  <ul class="list-unstyled">
                    {% for option in request.createItem.item.questionItem.question.choiceQuestion.options %}
                      {% set is_correct = option.value in request.createItem.item.questionItem.question.grading.correctAnswers.answers|map(attribute='value')|list %}
                      <li {% if is_correct %}class="correct-answer"{% endif %}>
                        <input type="radio" disabled> {{ option.value }}
                      </li>
                    {% endfor %}
                  </ul>
                {% endif %}
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}

    {% if form_url %}
      <div class="alert alert-success mt-4 text-center" role="alert">
        Form generated successfully! <a href="{{ form_url }}" target="_blank" class="alert-link">View Form</a>
      </div>
    {% endif %}

    {% if error_message %}
      <div class="alert alert-danger mt-4" role="alert">
        {{ error_message }}
      </div>
    {% endif %}

  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const historyItems = document.querySelectorAll('.prompt-history a'); // More specific selector
      const promptTextarea = document.getElementById('prompt');

      historyItems.forEach(item => {
        item.addEventListener('click', function(event) {
          event.preventDefault(); // Prevent default link behavior
          promptTextarea.value = item.textContent.trim(); // Trim whitespace
        });
      });
    });
  </script>
</body>
</html>
